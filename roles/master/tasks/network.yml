---
# This playbook configures the network

###########################
# Interface Configuration #
###########################

- name: Configure network interface
  copy:
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ master_network.device }}"
    content: |
      #ANSIBLE-BEGIN
      # The contents below are automatically generated by Ansible. Do not modify.
      DEVICE={{ master_network.device }}
      BOOTPROTO={{ master_network.ip_address | ternary('dhcp', 'static') }}
      ONBOOT=yes
      TYPE=Ethernet
      IPV6INIT=yes
      {% if master_network.ip_address != 'dhcp' %}
      # IPv4 Configuration
      IPADDR={{ master_network.ip_address }}
      NETMASK={{ master_network.ip_netmask }}
      GATEWAY={{ master_network.ip_gateway }}
      DNS1=8.8.8.8
      DNS2=8.8.4.4

      # IPv6 Configuration
      IPV6ADDR={{ master_network.ip_v6_address }}
      IPV6_DEFAULTGW={{ master_network.ip_v6_gateway }}
      IPV6_AUTOCONF=no
      {% else %}
      IPV6_AUTOCONF=yes
      {% endif %}
      #ANSIBLE-END
  register: network_config
  when: ansible_service_mgr == 'systemd'
  tags: interface-network

- name: Apply network changes
  command: nmcli connection reload
  when: 
    - network_config.changed
    - "'failed' not in network_config"
  changed_when: false